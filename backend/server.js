const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

console.log('üöÄ Iniciando servidor UnionAgro...');

// Criar pasta uploads se n√£o existir
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
    console.log('üìÅ Pasta uploads criada');
}

// Middleware
app.use(cors({
    origin: ['http://localhost:3000', 'http://localhost:5173', 'http://10.0.2.4:5173'],
    credentials: true
}));
app.use(express.json());
app.use('/uploads', express.static('uploads'));

// Inicializar banco de dados
let db;
try {
    db = require('./database/database');
    console.log('‚úÖ Banco de dados conectado');
} catch (error) {
    console.error('‚ùå Erro ao conectar banco:', error.message);
}

// ========== ROTAS PRINCIPAIS ==========

// Rota principal
app.get('/', (req, res) => {
    console.log('üì° Requisi√ß√£o recebida na rota /');
    res.json({ 
        message: 'üöõ UnionAgro API est√° funcionando!',
        timestamp: new Date().toISOString(),
        port: PORT,
        database: db ? 'conectado' : 'desconectado'
    });
});

// Rota de status
app.get('/api/status', (req, res) => {
    console.log('üì° Verificando status da API');
    res.json({ 
        status: 'online',
        database: db ? 'connected' : 'disconnected',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

// Rota de teste
app.get('/api/test', (req, res) => {
    console.log('üß™ Rota de teste acessada');
    res.json({ 
        test: 'OK',
        message: 'API funcionando perfeitamente!',
        timestamp: new Date().toISOString()
    });
});

// ========== ROTAS FREIGHT MAPS ==========

// Substitua sua rota GET /api/freight-maps existente por esta:
app.get('/api/freight-maps', (req, res) => {
    console.log('üì° Buscando freight maps com filtros:', req.query);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }

    let query = 'SELECT * FROM freight_maps';
    const params = [];
    const whereClauses = [];

    // Filtro por status
    if (req.query.status) {
        whereClauses.push('status = ?');
        params.push(req.query.status);
    }

    // Adicione mais filtros aqui se precisar no futuro, por exemplo:
    // if (req.query.selectedCarrier) {
    //     whereClauses.push('selectedCarrier = ?');
    //     params.push(req.query.selectedCarrier);
    // }

    if (whereClauses.length > 0) {
        query += ' WHERE ' + whereClauses.join(' AND ');
    }
    
    // Adicionar ordena√ß√£o padr√£o
    query += ' ORDER BY created_date DESC';

    db.all(query, params, (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar freight maps:', err);
            return res.status(500).json({ error: err.message });
        }
        
        // Deserializar campos JSON antes de enviar
        rows.forEach(row => {
            row.carrierProposals = JSON.parse(row.carrierProposals || '{}');
            row.invoiceUrls = JSON.parse(row.invoiceUrls || '[]');
        });
        
        res.json(rows);
    });
});

// Criar novo freight map
app.post('/api/freight-maps', (req, res) => {
    console.log('üì° Criando novo freight map');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    
    db.run(`
        INSERT INTO freight_maps (
            id, mapNumber, mapImage, origin, destination, totalKm, weight, mapValue, 
            truckType, loadingMode, loadingDate, routeInfo, carrierProposals, 
            status, invoiceUrls, created_by
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `, [
        id, data.mapNumber, data.mapImage || '', data.origin, data.destination, 
        data.totalKm, data.weight, data.mapValue, data.truckType, data.loadingMode, 
        data.loadingDate, data.routeInfo || '', 
        JSON.stringify(data.carrierProposals || {}), 
        data.status || 'negotiating', 
        JSON.stringify(data.invoiceUrls || []), 
        data.created_by || 'api'
    ], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar freight map:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Freight map criado com ID:', id);
        
        // Retornar o objeto criado
        const createdMap = {
            id,
            ...data,
            carrierProposals: data.carrierProposals || {},
            invoiceUrls: data.invoiceUrls || [],
            created_date: new Date().toISOString(),
            updated_date: new Date().toISOString()
        };
        
        res.status(201).json(createdMap);
    });
});

app.put('/api/freight-maps/:id', (req, res) => {
    console.log('üì° Atualizando freight map:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    const updates = req.body;
    
    // Serializar campos JSON antes de processar
    if (updates.carrierProposals) {
        updates.carrierProposals = JSON.stringify(updates.carrierProposals);
    }
    if (updates.invoiceUrls) {
        updates.invoiceUrls = JSON.stringify(updates.invoiceUrls);
    }
    
    const fields = Object.keys(updates);
    const values = Object.values(updates);
    
    if (fields.length === 0) {
        return res.status(400).json({ error: 'Nenhum campo para atualizar' });
    }
    
    const setClause = fields.map(field => `${field} = ?`).join(', ');
    
    // Query de atualiza√ß√£o din√¢mica
    const query = `UPDATE freight_maps SET ${setClause}, updated_date = CURRENT_TIMESTAMP WHERE id = ?`;
    
    db.run(query, [...values, id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao atualizar freight map:', err);
            return res.status(500).json({ error: err.message });
        }
        
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Freight map n√£o encontrado' });
        }
        
        console.log(`‚úÖ Freight map ${id} atualizado. Linhas afetadas: ${this.changes}`);
        
        // Retornar o registro atualizado do banco
        db.get('SELECT * FROM freight_maps WHERE id = ?', [id], (err, row) => {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            // Deserializar campos JSON antes de enviar de volta
            if (row) {
                row.carrierProposals = JSON.parse(row.carrierProposals || '{}');
                row.invoiceUrls = JSON.parse(row.invoiceUrls || '[]');
            }
            res.json(row);
        });
    });
});

// Deletar freight map
app.delete('/api/freight-maps/:id', (req, res) => {
    console.log('üì° Deletando freight map:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    
    db.run('DELETE FROM freight_maps WHERE id = ?', [id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao deletar freight map:', err);
            return res.status(500).json({ error: err.message });
        }
        
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Freight map n√£o encontrado' });
        }
        
        console.log('‚úÖ Freight map deletado');
        res.json({ message: 'Freight map deletado com sucesso' });
    });
});

// ========== ROTAS USERS ==========

// Listar usu√°rios
app.get('/api/users', (req, res) => {
    console.log('üì° Buscando usu√°rios');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    db.all('SELECT id, fullName, username, email, userType, carrierName, active, created_date FROM users', (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar usu√°rios:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úÖ Retornando ${rows.length} usu√°rios`);
        res.json(rows);
    });
});

// Criar usu√°rio
app.post('/api/users', (req, res) => {
    console.log('üì° Criando novo usu√°rio');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    const bcrypt = require('bcryptjs');
    
    if (!data.password) {
        return res.status(400).json({ error: 'Senha √© obrigat√≥ria' });
    }
    
    const hashedPassword = bcrypt.hashSync(data.password, 10);
    
    db.run(`
        INSERT INTO users (id, fullName, username, email, password, userType, carrierName, active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `, [
        id, data.fullName, data.username, data.email, hashedPassword, 
        data.userType || 'user', data.carrierName || null, 
        data.active !== undefined ? data.active : true
    ], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar usu√°rio:', err);
            if (err.message.includes('UNIQUE constraint failed')) {
                return res.status(400).json({ error: 'Nome de usu√°rio ou email j√° est√° em uso' });
            }
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Usu√°rio criado com ID:', id);
        
        // Retornar sem a senha
        const createdUser = {
            id,
            fullName: data.fullName,
            username: data.username,
            email: data.email,
            userType: data.userType || 'user',
            carrierName: data.carrierName || null,
            active: data.active !== undefined ? data.active : true,
            created_date: new Date().toISOString()
        };
        
        res.status(201).json(createdUser);
    });
});

// Atualizar usu√°rio
app.put('/api/users/:id', (req, res) => {
    console.log('üì° Atualizando usu√°rio:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    const data = req.body;
    const bcrypt = require('bcryptjs');
    
    let updateQuery = `
        UPDATE users SET 
            fullName = ?, username = ?, email = ?, userType = ?, 
            carrierName = ?, active = ?, updated_date = CURRENT_TIMESTAMP
    `;
    let params = [
        data.fullName, data.username, data.email, data.userType,
        data.carrierName, data.active
    ];
    
    // Se senha foi fornecida, incluir na atualiza√ß√£o
    if (data.password) {
        updateQuery += ', password = ?';
        params.push(bcrypt.hashSync(data.password, 10));
    }
    
    updateQuery += ' WHERE id = ?';
    params.push(id);
    
    db.run(updateQuery, params, function(err) {
        if (err) {
            console.error('‚ùå Erro ao atualizar usu√°rio:', err);
            if (err.message.includes('UNIQUE constraint failed')) {
                return res.status(400).json({ error: 'Nome de usu√°rio ou email j√° est√° em uso' });
            }
            return res.status(500).json({ error: err.message });
        }
        
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Usu√°rio n√£o encontrado' });
        }
        
        console.log('‚úÖ Usu√°rio atualizado');
        
        // Retornar dados atualizados sem senha
        const updatedUser = {
            id,
            fullName: data.fullName,
            username: data.username,
            email: data.email,
            userType: data.userType,
            carrierName: data.carrierName,
            active: data.active
        };
        
        res.json(updatedUser);
    });
});

// Deletar usu√°rio
app.delete('/api/users/:id', (req, res) => {
    console.log('üì° Deletando usu√°rio:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    
    db.run('DELETE FROM users WHERE id = ?', [id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao deletar usu√°rio:', err);
            return res.status(500).json({ error: err.message });
        }
        
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Usu√°rio n√£o encontrado' });
        }
        
        console.log('‚úÖ Usu√°rio deletado');
        res.json({ message: 'Usu√°rio deletado com sucesso' });
    });
});

// ========== ROTAS TRUCK TYPES ==========

app.get('/api/truck-types', (req, res) => {
    console.log('üì° Buscando tipos de caminh√£o');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    db.all('SELECT * FROM truck_types ORDER BY name', (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar truck types:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úÖ Retornando ${rows.length} tipos de caminh√£o`);
        res.json(rows);
    });
});

app.post('/api/truck-types', (req, res) => {
    console.log('üì° Criando tipo de caminh√£o');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    
    db.run(`
        INSERT INTO truck_types (id, name, capacity, baseRate, modality)
        VALUES (?, ?, ?, ?, ?)
    `, [id, data.name, data.capacity, data.baseRate, data.modality], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar truck type:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Truck type criado com ID:', id);
        res.status(201).json({ id, ...data });
    });
});

// ========== ROTAS CARRIERS ==========

app.get('/api/carriers', (req, res) => {
    console.log('üì° Buscando transportadoras');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    db.all('SELECT * FROM carriers ORDER BY name', (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar carriers:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úÖ Retornando ${rows.length} transportadoras`);
        res.json(rows);
    });
});

app.post('/api/carriers', (req, res) => {
    console.log('üì° Criando transportadora');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    
    db.run(`
        INSERT INTO carriers (id, name, type, active)
        VALUES (?, ?, ?, ?)
    `, [id, data.name, data.type, data.active !== undefined ? data.active : true], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar carrier:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Carrier criado com ID:', id);
        res.status(201).json({ id, ...data });
    });
});

// ========== ROTAS TRUCK TYPES ==========

// Listar tipos de caminh√£o
app.get('/api/truck-types', (req, res) => {
    console.log('üì° Buscando tipos de caminh√£o');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    db.all('SELECT * FROM truck_types ORDER BY name', (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar tipos de caminh√£o:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úÖ Retornando ${rows.length} tipos de caminh√£o`);
        res.json(rows);
    });
});

// Criar tipo de caminh√£o
app.post('/api/truck-types', (req, res) => {
    console.log('üì° Criando tipo de caminh√£o');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    
    db.run(`
        INSERT INTO truck_types (id, name, capacity, baseRate, modality)
        VALUES (?, ?, ?, ?, ?)
    `, [id, data.name, data.capacity, data.baseRate, data.modality], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar tipo de caminh√£o:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Tipo de caminh√£o criado com ID:', id);
        res.status(201).json({ id, ...data });
    });
});

// Atualizar tipo de caminh√£o
app.put('/api/truck-types/:id', (req, res) => {
    console.log('üì° Atualizando tipo de caminh√£o:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    const data = req.body;
    
    db.run(`
        UPDATE truck_types SET 
            name = ?, capacity = ?, baseRate = ?, modality = ?, updated_date = CURRENT_TIMESTAMP
        WHERE id = ?
    `, [data.name, data.capacity, data.baseRate, data.modality, id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao atualizar tipo de caminh√£o:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Tipo de caminh√£o atualizado');
        res.json({ id, ...data });
    });
});

// Deletar tipo de caminh√£o
app.delete('/api/truck-types/:id', (req, res) => {
    console.log('üì° Deletando tipo de caminh√£o:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    
    db.run('DELETE FROM truck_types WHERE id = ?', [id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao deletar tipo de caminh√£o:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Tipo de caminh√£o deletado');
        res.json({ success: true });
    });
});

// ========== ROTAS CARRIERS ==========

// Listar transportadoras
app.get('/api/carriers', (req, res) => {
    console.log('üì° Buscando transportadoras');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    db.all('SELECT * FROM carriers ORDER BY name', (err, rows) => {
        if (err) {
            console.error('‚ùå Erro ao buscar transportadoras:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úÖ Retornando ${rows.length} transportadoras`);
        res.json(rows);
    });
});

// Criar transportadora
app.post('/api/carriers', (req, res) => {
    console.log('üì° Criando transportadora');
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const data = req.body;
    const id = crypto.randomUUID();
    
    db.run(`
        INSERT INTO carriers (id, name, type, active)
        VALUES (?, ?, ?, ?)
    `, [id, data.name, data.type, data.active], function(err) {
        if (err) {
            console.error('‚ùå Erro ao criar transportadora:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Transportadora criada com ID:', id);
        res.status(201).json({ id, ...data });
    });
});

// Atualizar transportadora
app.put('/api/carriers/:id', (req, res) => {
    console.log('üì° Atualizando transportadora:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    const data = req.body;
    
    db.run(`
        UPDATE carriers SET 
            name = ?, type = ?, active = ?, updated_date = CURRENT_TIMESTAMP
        WHERE id = ?
    `, [data.name, data.type, data.active, id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao atualizar transportadora:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Transportadora atualizada');
        res.json({ id, ...data });
    });
});

// Deletar transportadora
app.delete('/api/carriers/:id', (req, res) => {
    console.log('üì° Deletando transportadora:', req.params.id);
    if (!db) {
        return res.status(500).json({ error: 'Banco de dados n√£o conectado' });
    }
    
    const { id } = req.params;
    
    db.run('DELETE FROM carriers WHERE id = ?', [id], function(err) {
        if (err) {
            console.error('‚ùå Erro ao deletar transportadora:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ Transportadora deletada');
        res.json({ success: true });
    });
});

// ========== UPLOAD DE ARQUIVOS ==========

const multer = require('multer');
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, 'uploads/');
    },
    filename: (req, file, cb) => {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, uniqueSuffix + path.extname(file.originalname));
    }
});

const upload = multer({ 
    storage,
    limits: {
        fileSize: 10 * 1024 * 1024 // 10MB
    },
    fileFilter: (req, file, cb) => {
        // Aceitar imagens e PDFs
        if (file.mimetype.startsWith('image/') || file.mimetype === 'application/pdf') {
            cb(null, true);
        } else {
            cb(new Error('Apenas imagens e PDFs s√£o permitidos'));
        }
    }
});

app.post('/api/upload', upload.single('file'), (req, res) => {
    console.log('üì° Upload de arquivo');
    if (!req.file) {
        return res.status(400).json({ error: 'Nenhum arquivo enviado' });
    }
    
    const fileUrl = `http://localhost:${PORT}/uploads/${req.file.filename}`;
    console.log('‚úÖ Arquivo uploaded:', fileUrl);
    res.json({ 
        file_url: fileUrl,
        filename: req.file.filename,
        originalname: req.file.originalname,
        size: req.file.size
    });
});

// ========== MIDDLEWARE DE ERRO ==========

// Middleware de erro para upload
app.use((err, req, res, next) => {
    if (err instanceof multer.MulterError) {
        if (err.code === 'LIMIT_FILE_SIZE') {
            return res.status(400).json({ error: 'Arquivo muito grande. M√°ximo 10MB.' });
        }
    }
    
    if (err.message === 'Apenas imagens e PDFs s√£o permitidos') {
        return res.status(400).json({ error: err.message });
    }
    
    console.error('‚ùå Erro no servidor:', err.stack);
    res.status(500).json({ 
        error: 'Erro interno do servidor',
        message: err.message 
    });
});

// ========== INICIALIZA√á√ÉO DO SERVIDOR ==========

// Iniciar servidor
app.listen(PORT, (err) => {
    if (err) {
        console.error('‚ùå Erro ao iniciar servidor:', err);
        return;
    }
    
    console.log('üöÄ ========================================');
    console.log(`üöõ UnionAgro API rodando na porta ${PORT}`);
    console.log(`üì° URL Principal: http://localhost:${PORT}`);
    console.log(`üß™ Status: http://localhost:${PORT}/api/status`);
    console.log(`üß™ Teste: http://localhost:${PORT}/api/test`);
    console.log(`üìä Freight Maps: http://localhost:${PORT}/api/freight-maps`);
    console.log(`üë• Usu√°rios: http://localhost:${PORT}/api/users`);
    console.log('========================================');
});

// Tratamento de erros n√£o capturados
process.on('uncaughtException', (err) => {
    console.error('‚ùå Erro n√£o capturado:', err);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå Promise rejeitada n√£o tratada:', reason);
});

module.exports = app;